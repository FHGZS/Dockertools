(function(e){(function(e,i,t){var n='style="width: 80%;"',a={ui:{grid_admin_user:{name:"grid_admin_user",show:{lineNumbers:true,selectColumn:true,footer:true,toolbar:true},multiSearch:false,columns:[{field:"_id",hidden:true,caption:"ID"},{field:"email",caption:"邮箱",size:"14%",sortable:true},{field:"nickname",caption:"昵称",size:"10%",sortable:true},{field:"verify",caption:"是否验证",size:"10%",sortable:true},{field:"isadmin",caption:"是否管理",size:"10%",sortable:true,hidden:true},{field:"buy_bomb",caption:"购买蚁弹超人",size:"10%",sortable:true},{field:"coin",caption:"蚁币",size:"10%",sortable:true},{field:"regip",caption:"注册IP",size:"10%",sortable:true},{field:"regtime",caption:"注册时间",size:"13%",sortable:true},{field:"loginip",caption:"登录IP",size:"10%",sortable:true},{field:"logintime",caption:"登录时间",size:"13%",sortable:true}],searches:[{field:"email",caption:"邮箱",type:"text"},{field:"nickname",caption:"昵称",type:"text"},{field:"verify",caption:"是否验证",type:"text"},{field:"isadmin",caption:"是否管理",type:"text"},{field:"buy_bomb",caption:"购买蚁弹超人",type:"text"},{field:"coin",caption:"蚁币",type:"text"},{field:"regip",caption:"注册IP",type:"text"},{field:"regtime",caption:"注册时间",type:"text"},{field:"loginip",caption:"登录IP",type:"text"},{field:"logintime",caption:"登录时间",type:"text"}],onContextMenu:function(i){var t=this,n=t.getSelection(),o=t.get(n[0]),r=[];n.forEach(function(e){r.push(t.get(e)._id)});e().bmenu([{text:"充值蚁币",icon:"fa fa-money",disabled:r.length!==1,action:function(){a.pay(r[0])}},{divider:true},{text:"编辑用户",icon:"fa fa-edit",disabled:r.length!==1,action:function(){a.edit(r[0])}},{divider:true},{text:"删除用户",icon:"fa fa-trash-o",count:r.length,disabled:r.length===0,action:function(){a.del(r)}}],i.originalEvent)}},form_admin_user:{name:"form_admin_user",fields:[{type:"text",field:"nickname",required:true,html:{caption:"昵称",attr:n}},{type:"email",field:"email",required:true,html:{caption:"邮箱",attr:n}},{type:"int",field:"coin",required:true,html:{caption:"蚁币",attr:n}},{type:"password",field:"password",html:{caption:"更改密码",attr:n}},{type:"checkbox",field:"verify",html:{caption:"是否验证"}},{type:"checkbox",field:"isadmin",html:{caption:"是否管理"}},{type:"checkbox",field:"buy_bomb",html:{caption:"蚁弹超人"}}],toolbar:{items:[{id:"save",type:"button",icon:"fa fa-save",caption:"保存"},{type:"break"}]}}},cache:null,refresh:function(){var n=a;!i.get("ant_admin").expanded?i.expand("ant_admin"):null;t.content("main",w2ui["grid_admin_user"]);if(!n.cache){t.lock("main","获取用户数据中..",true);n.cache={};e.get("/addons/ant.admin.user/data",function(e){e.forEach(function(e){n.cache[e._id]=e});n.reload()})}else{n.reload()}},reload:function(){var e=this,n=[];for(var a in e.cache){var o=e.cache[a];if(o){n.push({recid:n.length+1,_id:o._id,email:w2utils.encodeTags(o.email),nickname:w2utils.encodeTags(o.nickname),verify:o.verify?"是":"否",isadmin:o.isadmin?"是":"否",buy_bomb:o.buy_bomb?"是":"否",coin:o.coin,regip:w2utils.encodeTags(o.regip),regtime:ANT.ftime(o.regtime),loginip:w2utils.encodeTags(o.loginip),logintime:ANT.ftime(o.logintime),style:o.verify?o.isadmin?"color:rgb(195, 45, 9);background-color:#FBFEC0;":"":"color:rgb(195, 45, 9);"})}}w2ui["grid_admin_user"].records=n;w2ui["grid_admin_user"].sort("_id","desc");w2ui["grid_admin_user"].refresh();setTimeout(function(){i.set("admin_user",{count:n.length});t.unlock("main")},100)},edit:function(i){var t=this,n=t.cache[i];w2popup.open({title:'<i class="fa fa-user"></i> 编辑用户',style:"padding: 0px;",modal:true,showMax:false,width:600,height:450,body:'<div id="admin_user_div" style="width:100%;height:100%;"></div>',onOpen:function(a){a.onComplete=function(){w2ui["form_admin_user"]?w2ui["form_admin_user"].destroy():null;e("#admin_user_div").w2form(t.ui.form_admin_user);w2ui["form_admin_user"].record={email:n.email,nickname:n.nickname,coin:n.coin,verify:n.verify,isadmin:n.isadmin,buy_bomb:n.buy_bomb};w2ui["form_admin_user_toolbar"].onClick=function(a){if(a.target==="save"){w2popup.lock("保存用户信息中..",true);var o=w2ui["form_admin_user"].record;e.post("/addons/ant.admin.user/save",e.extend({},o,{id:i}),function(a){w2popup.unlock();if(a.err){toastr.error("保存失败!<br>"+a.err,"Error")}else{toastr.success("保存成功!","Success");t.cache[i]=e.extend({},n,o);t.reload();w2popup.close()}})}}}}})},del:function(i){var n=this;w2confirm("确定删除所选用户?",function(a){if(a!=="Yes"){return false}t.lock("main","删除用户中..",true);e.post("/addons/ant.admin.user/del",{ids:i},function(e){t.unlock("main");if(!e.err){toastr.success("删除成功!","Success");i.forEach(function(e){delete n.cache[e]});n.reload()}else{toastr.error("删除失败!<br>"+e.err,"Error")}})})},pay:function(i){var t=this;w2popup.open({title:'<i class="fa fa-money"></i> 充值蚁币',modal:true,width:550,height:350,style:"padding: 0",body:'<div id="admin_user_pay_div" style="width:100%;height:100;"></div>',onOpen:function(n){n.onComplete=function(){w2ui["admin_user_pay_div"]?w2ui["admin_user_pay_div"].destroy():null;e("#admin_user_pay_div").w2form({name:"admin_user_pay_div",style:"height:100%;",fields:[{field:"coin",type:"int",required:true,html:{caption:"蚁币",attr:'style="width:80%"'}},{type:"checkbox",field:"mail",html:{caption:"邮件提醒"}},{type:"textarea",field:"why",html:{caption:"操作原因",attr:'rows="10" style="width:80%"'}}],actions:{"充值":function(){var n=this;if(n.validate().length===0){w2popup.lock("充值蚁币中..",true);e.post("/addons/ant.admin.user/pay",e.extend(n.record,{id:i}),function(e){w2popup.unlock();if(e.ret){toastr.success("充值成功!","Success");w2popup.close();t.cache[i].coin+=parseInt(n.record.coin);t.reload()}else{toastr.error("充值失败!<br>"+e.err,"Error")}})}}}})}}})}};e().w2grid(a.ui.grid_admin_user);i.add("ant_admin",{id:"admin_user",icon:"fa fa-user",text:"用户管理",onClick:function(){a.refresh()},onDblClick:function(){delete a.cache;a.refresh()}})})(jQuery,w2ui["sidebar"],w2ui["layout"])})();