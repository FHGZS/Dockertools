(function(e){(function(e,t,i){var o={ui:{grid_admin_blog:{name:"grid_admin_blog",show:{lineNumbers:true,selectColumn:true,footer:true,toolbar:true,expandColumn:true},multiSearch:false,columns:[{field:"_id",hidden:true,caption:"ID"},{field:"category",caption:"蚁记目录",size:"10%",sortable:true},{field:"title",caption:"蚁记标题",size:"30%",sortable:true},{field:"user",caption:"蚁记作者",size:"10%",sortable:true},{field:"verify",caption:"是否审核",size:"10%",sortable:true},{field:"ctime",caption:"创建时间",size:"15%",sortable:true},{field:"utime",caption:"更新时间",size:"15%",sortable:true}],records:[],searches:[{field:"category",caption:"蚁记目录",type:"text"},{field:"title",caption:"蚁记标题",type:"text"},{field:"user",caption:"蚁记作者",type:"text"},{field:"verify",caption:"是否审核",type:"text"},{field:"ctime",caption:"创建时间",type:"text"},{field:"utime",caption:"更新时间",type:"text"}],onContextMenu:function(t){var i=this,n=i.getSelection(),a=i.get(n[0]),r=[];n.forEach(function(e){r.push(i.get(e)._id)});e().bmenu([{text:"编辑蚁记",icon:"fa fa-edit",disabled:r.length!==1,action:function(){o.edit(r[0])}},{text:"更改设置",icon:"fa fa-cog",disabled:r.length!==1,action:function(){o.setting(r[0])}},{divider:true},{text:"审核蚁记",icon:"fa fa-check-square-o",action:function(){o.verify(r,true)}},{text:"取消审核",icon:"fa fa-remove",action:function(){o.verify(r,false)}},{divider:true},{text:"删除蚁记",icon:"fa fa-trash-o",count:r.length,disabled:r.length===0,action:function(){o.del(r)}}],t.originalEvent)}},form_admin_blog:{name:"form_admin_blog",style:"height: 100%;border: 0px;background-color: transparent;",fields:[{field:"category",type:"text",required:true,html:{caption:"蚁记目录",attr:'style="width: 250px"'}},{field:"title",type:"text",required:true,html:{caption:"蚁记标题",attr:'style="width: 250px"'}},{field:"desc",type:"textarea",html:{caption:"蚁记简介",attr:'rows="8" style="width: 250px;"'}}]},layout_admin_blog:{name:"layout_admin_blog",panels:[{size:"100%",type:"left",style:"border: 1px solid #dfdfdf;",content:'<div id="layout_admin_blog_edit" style="width:100%;height:100%;"></div>',resizable:true,toolbar:{items:[{id:"save",icon:"fa fa-save",hint:"[Ctrl || Command] + S",type:"button",caption:"保存"},{type:"break"},{id:"preview",type:"check",icon:"fa fa-eye",hint:"[Ctrl || Command] + E",caption:"预览"}]}},{size:"100%",type:"main",style:"border: 1px solid #dfdfdf;",content:'<div id="blog_view_content"></div>',resizable:true}]}},cache:null,refresh:function(){var n=o;!t.get("ant_admin").expanded?t.expand("ant_admin"):null;i.content("main",w2ui["grid_admin_blog"]);if(!n.cache){i.lock("main","获取蚁记数据中..",true);n.cache={};e.get("/addons/ant.admin.blog/data",function(e){e.forEach(function(e){n.cache[e._id]=e});n.reload()})}else{n.reload()}},reload:function(){var e=this,o=[];for(var n in e.cache){var a=e.cache[n];if(a){o.push({recid:o.length+1,_id:a._id,category:w2utils.encodeTags(a.category),title:w2utils.encodeTags(a.title),user:w2utils.encodeTags(a.user?a.user.nickname:"<已删除>"),verify:a.verify?"是":"否",ctime:ANT.ftime(a.ctime),utime:ANT.ftime(a.utime),style:a.verify?"":"color:rgb(195, 45, 9);background-color:#FBFEC0;"})}}w2ui["grid_admin_blog"].records=o;w2ui["grid_admin_blog"].sort("_id","desc");w2ui["grid_admin_blog"].refresh();setTimeout(function(){t.set("admin_blog",{count:o.length});i.unlock("main")},100)},del:function(t){var o=this;w2confirm("确定删除所选蚁记?",function(n){if(n!=="Yes"){return false}i.lock("main","删除蚁记中..",true);e.post("/addons/ant.admin.blog/del",{ids:t},function(e){i.unlock("main");if(!e.err){toastr.success("删除成功!","Success");t.forEach(function(e){delete o.cache[e]});o.reload()}else{toastr.error("删除失败!<br>"+e.err,"Error")}})})},edit:function(t){var i=this,o=i.cache[t],n=null;w2popup.open({title:'<i class="fa fa-edit"></i> 编辑蚁记:<strong class="text-success">'+w2utils.encodeTags(o.title)+"</strong>",body:'<div id="layout_admin_blog_div" style="width: 100%;height: 100%;"></div>',style:"padding: 0;",showMax:true,modal:true,width:900,height:600,onOpen:function(a){a.onComplete=function(){e("#layout_admin_blog_div").w2render(w2ui["layout_admin_blog"]);var a=require("ace/mode/markdown").Mode;n=ace.edit("layout_admin_blog_edit");n.setTheme("ace/theme/tomorrow");n.session.setMode(new a);n.session.setUseWrapMode(true);n.session.setValue(o.content||"");[{name:"saveCmd",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){w2ui["layout_admin_blog_left_toolbar"].click("save")}},{name:"previewCmd",bindKey:{win:"Ctrl-E",mac:"Command-E"},exec:function(e){w2ui["layout_admin_blog_left_toolbar"].click("preview")}},{name:"toggleCmd",bindKey:{win:"Ctrl-M",mac:"Command-M"},exec:function(){w2popup.toggle()}}].forEach(function(e){n.commands.addCommand(e)});w2ui["layout_admin_blog_left_toolbar"].onClick=function(a){switch(a.target){case"save":w2popup.lock("保存蚁记中..",true);e.post("/addons/ant.admin.blog/save",{id:t,content:n.getValue()},function(e){w2popup.unlock();if(e.err){toastr.error("保存蚁记失败!<br>"+e.err,"Error")}else{toastr.success("保存蚁记成功!","Success");o.content=n.getValue();i.reload()}});break;case"preview":w2ui["layout_admin_blog"].set("left",{size:!a.object.checked?"50%":"100%"});this.set("preview",{icon:!a.object.checked?"fa fa-eye fa-spin":"fa fa-eye"});!a.object.checked?ANT.addons.ant_blog.blog.parse("blog_view_content",o,n.getValue()):null;break}};w2popup.toggle()}},onToggle:function(e){e.onComplete=function(){w2ui["layout_admin_blog"].set("left",{size:w2ui["layout_admin_blog_left_toolbar"].get("preview").checked?"50%":"100%"});w2ui["layout_admin_blog"].resize();n.resize()}},onClose:function(e){this.onMin(e)},onMin:function(e){e.onComplete=function(){w2ui["layout_admin_blog_left_toolbar"].get("preview").checked?w2ui["layout_admin_blog_left_toolbar"].click("preview"):null}}})},setting:function(t){var i=this,n=i.cache[t];w2popup.open({title:'<i class="fa fa-pencil"></i> 更改设置',body:'<div id="form_admin_blog_div"></div>',style:"padding: 15px 0 0 0",modal:true,width:500,height:350,onOpen:function(a){a.onComplete=function(){var a=e.extend({},o.ui["form_admin_blog"],{record:{category:n.category,title:n.title,desc:n.desc},actions:{"保存":function(){if(this.validate().length===0){w2popup.lock("保存设置中..",true);var o=this.record;e.post("/addons/ant.admin.blog/setting",e.extend(o,{id:t}),function(e){w2popup.unlock();if(!e.err){w2popup.close();toastr.success("保存设置成功!","Success");n.category=o.category;n.title=o.title;n.desc=o.desc;i.reload()}else{toastr.error("保存设置失败!<br>"+e.err,"Error")}})}}}});e("#form_admin_blog_div").w2form(a)}},onClose:function(e){w2ui["form_admin_blog"].destroy()}})},verify:function(t,o){var n=this;if(o){w2confirm("确定审核所选蚁记吗?",function(o){if(o!=="Yes"){return false}i.lock("main","审核蚁记中..",true);e.post("/addons/ant.admin.blog/verify",{ids:t,verify:true},function(e){i.unlock("main");if(!e.err){toastr.success("审核成功!","Success");t.forEach(function(e){n.cache[e].verify=true});n.reload()}else{toastr.error("审核失败!<br>"+e.err,"Error")}})})}else{w2confirm("确定取消审核所选蚁记吗?",function(o){if(o!=="Yes"){return false}i.lock("main","取消审核蚁记中..",true);e.post("/addons/ant.admin.blog/verify",{ids:t,verify:false},function(e){i.unlock("main");if(!e.err){toastr.success("取消审核成功!","Success");t.forEach(function(e){n.cache[e].verify=false});n.reload()}else{toastr.error("取消审核失败!<br>"+e.err,"Error")}})})}}};e().w2grid(o.ui.grid_admin_blog);e().w2layout(o.ui.layout_admin_blog);t.add("ant_admin",{id:"admin_blog",icon:"fa fa-book",text:"蚁记审核",onClick:function(){o.refresh()},onDblClick:function(){delete o.cache;o.refresh()}})})(jQuery,w2ui["sidebar"],w2ui["layout"])})();