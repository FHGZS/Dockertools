(function(e){(function(e,t,i){var o={ui:{grid_admin_bomb:{name:"grid_admin_bomb",show:{lineNumbers:true,selectColumn:true,footer:true,toolbar:true,expandColumn:true},multiSearch:false,columns:[{field:"_id",hidden:true,caption:"ID"},{field:"name",caption:"插件名称",size:"30%",sortable:true},{field:"user",caption:"插件作者",size:"10%",sortable:true},{field:"coin",caption:"出售蚁币",size:"10%",sortable:true},{field:"verify",caption:"是否审核",size:"10%",sortable:true},{field:"ctime",caption:"创建时间",size:"15%",sortable:true},{field:"utime",caption:"更新时间",size:"15%",sortable:true}],records:[],searches:[{field:"name",caption:"插件名称",type:"text"},{field:"user",caption:"插件作者",type:"text"},{field:"coin",caption:"出售蚁币",type:"text"},{field:"verify",caption:"是否审核",type:"text"},{field:"ctime",caption:"创建时间",type:"text"},{field:"utime",caption:"更新时间",type:"text"}],onContextMenu:function(t){var i=this,n=i.getSelection(),r=i.get(n[0]),a=[];n.forEach(function(e){a.push(i.get(e)._id)});e().bmenu([{text:"编辑插件",icon:"fa fa-edit",disabled:a.length!==1,action:function(){o.edit(a[0])}},{text:"更改设置",icon:"fa fa-cog",disabled:a.length!==1,action:function(){o.setting(a[0])}},{divider:true},{text:"审核插件",icon:"fa fa-check-square-o",action:function(){o.verify(a,true)}},{text:"取消审核",icon:"fa fa-remove",action:function(){o.verify(a,false)}},{divider:true},{text:"删除插件",icon:"fa fa-trash-o",count:a.length,disabled:a.length===0,action:function(){o.del(a)}}],t.originalEvent)}},layout_admin_bomb_edit:{name:"layout_admin_bomb_edit",panels:[{size:"100%",type:"main",style:"border: 1px solid #dfdfdf;",content:""+'<div id="layout_admin_bomb_edit_client" class="bomb_editor" style="width: 100%;height:100%;font-size: 14px;"></div>'+'<div id="layout_admin_bomb_edit_server" class="bomb_editor" style="width: 100%;height:100%;font-size: 14px;"></div>',resizable:true,toolbar:{items:[{id:"save",icon:"fa fa-save",hint:"[Ctrl || Command] + S",type:"button",caption:"保存"},{type:"break"}]},tabs:{tabs:[{id:"client",caption:'<i class="fa fa-code"></i> 客户端'},{id:"server",caption:'<i class="fa fa-skyatlas"></i> 服务端'}],onClick:function(t){e(".bomb_editor").hide();e("#layout_admin_bomb_edit_"+t.target).show();o.editor[t.target].resize()}}}]},form_admin_bomb_setting:{name:"form_admin_bomb_setting",style:"height: 100%;border: 0px;background-color: transparent;",fields:[{field:"name",type:"text",required:true,html:{caption:"插件名称",attr:'style="width: 250px"'}},{field:"coin",type:"int",required:true,html:{caption:"出售蚁币",attr:'style="width: 250px;"'}},{field:"desc",type:"textarea",html:{caption:"插件简介",attr:'rows="8" style="width: 250px;"'}}]}},cache:null,editor:{},refresh:function(){var o=this;!t.get("ant_admin").expanded?t.expand("ant_admin"):null;i.content("main",w2ui["grid_admin_bomb"]);if(!o.cache){i.lock("main","获取插件数据中..",true);o.cache={};e.get("/addons/ant.admin.bomb/data",function(e){e.forEach(function(e){o.cache[e._id]=e});o.reload()})}else{o.reload()}},reload:function(){var e=this,o=[];for(var n in e.cache){var r=e.cache[n];if(r){o.push({recid:o.length+1,_id:r._id,name:w2utils.encodeTags(r.name),user:w2utils.encodeTags(r.user?r.user.nickname:"<已删除>"),coin:r.coin,verify:r.verify?"是":"否",ctime:ANT.ftime(r.ctime),utime:ANT.ftime(r.utime),style:r.verify?"":"color:rgb(195, 45, 9);background-color:#FBFEC0;"})}}w2ui["grid_admin_bomb"].records=o;w2ui["grid_admin_bomb"].sort("_id","desc");w2ui["grid_admin_bomb"].refresh();setTimeout(function(){t.set("admin_bomb",{count:o.length});i.unlock("main")},100)},del:function(t){var o=this;w2confirm("确定删除所选插件?",function(n){if(n!=="Yes"){return false}i.lock("main","删除插件中..",true);e.post("/addons/ant.admin.bomb/del",{ids:t},function(e){i.unlock("main");if(!e.err){toastr.success("删除成功!","Success");t.forEach(function(e){delete o.cache[e]});o.reload()}else{toastr.error("删除失败!<br>"+e.err,"Error")}})})},verify:function(t,o){var n=this;if(o){w2confirm("确定审核所选插件吗?",function(o){if(o!=="Yes"){return false}i.lock("main","审核插件中..",true);e.post("/addons/ant.admin.bomb/verify",{ids:t,verify:true},function(e){i.unlock("main");if(!e.err){toastr.success("审核成功!","Success");t.forEach(function(e){n.cache[e].verify=true});n.reload()}else{toastr.error("审核失败!<br>"+e.err,"Error")}})})}else{w2confirm("确定取消审核所选插件吗?",function(o){if(o!=="Yes"){return false}i.lock("main","取消审核插件中..",true);e.post("/addons/ant.admin.bomb/verify",{ids:t,verify:false},function(e){i.unlock("main");if(!e.err){toastr.success("取消审核成功!","Success");t.forEach(function(e){n.cache[e].verify=false});n.reload()}else{toastr.error("取消审核失败!<br>"+e.err,"Error")}})})}},edit:function(t){var i=this,o=i.cache[t];w2popup.open({title:'<i class="fa fa-edit"></i> 编辑插件:<strong class="text-danger">'+w2utils.encodeTags(o.name)+"</strong>",body:'<div id="layout_admin_bomb_edit_div" style="width: 100%;height: 100%;"></div>',style:"padding: 0;",showMax:true,modal:true,width:900,height:600,onOpen:function(n){n.onComplete=function(){e("#layout_admin_bomb_edit_div").w2render(w2ui["layout_admin_bomb_edit"]);var n=require("ace/mode/javascript").Mode;i.editor.client=ace.edit("layout_admin_bomb_edit_client");i.editor.client.setTheme("ace/theme/tomorrow");i.editor.client.session.setMode(new n);i.editor.client.session.setUseWrapMode(true);i.editor.client.session.setValue(o.code.client);i.editor.server=ace.edit("layout_admin_bomb_edit_server");i.editor.server.setTheme("ace/theme/tomorrow");i.editor.server.session.setMode(new n);i.editor.server.session.setUseWrapMode(true);i.editor.server.session.setValue(o.code.server);[{name:"saveCmd",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){w2ui["layout_admin_bomb_edit_main_toolbar"].click("save")}},{name:"toggleCmd",bindKey:{win:"Ctrl-M",mac:"Command-M"},exec:function(){w2popup.toggle()}}].forEach(function(e){i.editor.client.commands.addCommand(e);i.editor.server.commands.addCommand(e)});w2ui["layout_admin_bomb_edit_main_toolbar"].onClick=function(n){if(n.target!=="save"){return false}var r=i.editor.client.getValue();var a=i.editor.server.getValue();w2popup.lock("保存代码中..",true);e.post("/addons/ant.admin.bomb/save",{id:t,client:r,server:a},function(e){w2popup.unlock();if(e.err){toastr.error("代码保存失败!<br>"+e.err,"Error")}else{o.code={client:r,server:a};i.reload();toastr.success("代码保存成功!","Success")}})};w2ui["layout_admin_bomb_edit_main_tabs"].click("client");w2popup.toggle()}},onToggle:function(e){e.onComplete=function(){w2ui["layout_admin_bomb_edit"].resize();i.editor.client.resize();i.editor.server.resize()}}})},setting:function(t){var i=this,n=i.cache[t];w2popup.open({title:'<i class="fa fa-cog"></i> 更改设置',body:'<div id="form_admin_bomb_setting_div"></div>',style:"padding: 15px 0 0 0",modal:true,width:500,height:350,onOpen:function(r){r.onComplete=function(){var r=e.extend({},o.ui["form_admin_bomb_setting"],{record:{name:n.name,coin:n.coin,desc:n.desc},actions:{"更新":function(){var o=this.record;if(this.validate().length===0){w2popup.lock("更新插件中..",true);e.post("/addons/ant.admin.bomb/setting",{id:t,name:o.name,coin:o.coin,desc:o.desc},function(r){if(r.ret){w2popup.close();toastr.success("更新插件成功!","Success");n=e.extend({},n,o);i.cache[t]=n;i.reload()}else{toastr.error("更新插件失败!<br>"+r.err,"Error")}})}}}});e("#form_admin_bomb_setting_div").w2form(r)}},onClose:function(e){w2ui["form_admin_bomb_setting"].destroy()}})}};e().w2grid(o.ui.grid_admin_bomb);e().w2layout(o.ui.layout_admin_bomb_edit);t.add("ant_admin",{id:"admin_bomb",icon:"fa fa-puzzle-piece",text:"蚁弹插件",onClick:function(){o.refresh()},onDblClick:function(){delete o.cache;o.refresh()}})})(jQuery,w2ui["sidebar"],w2ui["layout"])})();