(function(e){(function(e,i,t){var o={ui:{grid_admin_soldier:{name:"grid_admin_soldier",show:{lineNumbers:true,selectColumn:true,footer:true,toolbar:true},multiSearch:false,columns:[{field:"_id",hidden:true,caption:"ID"},{field:"aid",caption:"兵蚁编号",size:"14%",sortable:true},{field:"name",caption:"兵蚁大名",size:"10%",sortable:true},{field:"env",caption:"运行环境",size:"10%",sortable:true},{field:"user",caption:"兵蚁作者",size:"10%",sortable:true},{field:"coin",caption:"出售蚁币",size:"10%",sortable:true},{field:"buy",caption:"购买次数",size:"10%",sortable:true},{field:"ctime",caption:"创建时间",size:"10%",sortable:true},{field:"utime",caption:"更新时间",size:"13%",sortable:true}],searches:[{field:"aid",caption:"兵蚁编号",type:"text"},{field:"name",caption:"兵蚁大名",type:"text"},{field:"env",caption:"运行环境",type:"text"},{field:"user",caption:"兵蚁作者",type:"text"},{field:"coin",caption:"出售蚁币",type:"text"},{field:"buy",caption:"购买次数",type:"text"},{field:"ctime",caption:"创建时间",type:"text"},{field:"utime",caption:"更新时间",type:"text"}],onContextMenu:function(i){var t=this,r=t.getSelection(),n=t.get(r[0]),a=[];r.forEach(function(e){a.push(t.get(e)._id)});e().bmenu([{text:"编辑兵蚁",icon:"fa fa-edit",disabled:a.length!==1,action:function(){o.edit(a[0])}},{text:"更改设置",icon:"fa fa-cog",disabled:a.length!==1,action:function(){o.setting(a[0])}},{divider:true},{text:"审核兵蚁",icon:"fa fa-check-square-o",action:function(){o.verify(a,true)}},{text:"取消审核",icon:"fa fa-remove",action:function(){o.verify(a,false)}},{divider:true},{text:"删除兵蚁",icon:"fa fa-trash-o",count:a.length,disabled:a.length===0,action:function(){o.del(a)}}],i.originalEvent)}},form_admin_soldier:{name:"form_admin_soldier",style:"height: 100%;border: 0px;background-color: transparent;",fields:[{field:"name",type:"text",required:true,html:{caption:"兵蚁大名",attr:'style="width: 90%"'}},{field:"coin",type:"int",required:true,html:{caption:"出售蚁币",attr:'style="width:90%"'}},{field:"desc",type:"textarea",html:{caption:"简单说明",attr:'rows="10" style="width: 90%"'}}],toolbar:{items:[{id:"save",type:"button",caption:"保存",icon:"fa fa-save"},{type:"break"}]}},layout_admin_soldier:{name:"layout_admin_soldier",panels:[{size:"100%",type:"main",style:"border: 1px solid #dfdfdf;",content:""+'<div id="layout_admin_soldier_client" class="soldier_editor" style="width: 100%;height:100%;font-size: 14px;"></div>'+'<div id="layout_admin_soldier_server" class="soldier_editor" style="width: 100%;height:100%;font-size: 14px;"></div>',toolbar:{items:[{id:"save",icon:"fa fa-save",hint:"[Ctrl || Command] + S",type:"button",caption:"保存"},{type:"break"}]},tabs:{tabs:[{id:"client",caption:'<i class="fa fa-code"></i> 客户端'},{id:"server",caption:'<i class="fa fa-skyatlas"></i> 服务端'}],onClick:function(i){e(".soldier_editor").hide();e("#layout_admin_soldier_"+i.target).show();o.editor[i.target].resize()}}}]}},cache:null,editor:{},refresh:function(){var r=o;!i.get("ant_admin").expanded?i.expand("ant_admin"):null;t.content("main",w2ui["grid_admin_soldier"]);if(!r.cache){t.lock("main","获取兵蚁数据中..",true);r.cache={};e.get("/addons/ant.admin.soldier/data",function(e){e.forEach(function(e){r.cache[e._id]=e});r.reload()})}else{r.reload()}},reload:function(){var e=this,o=[];for(var r in e.cache){var n=e.cache[r];if(n){o.push({recid:o.length+1,_id:n._id,aid:"ant-"+n.cms+"-"+n.aid,name:w2utils.encodeTags(n.name),env:w2utils.encodeTags(n.env),user:w2utils.encodeTags(n.user?n.user.nickname:"<已删除>"),coin:n.coin,buy:n.members.length,ctime:ANT.ftime(n.ctime),utime:ANT.ftime(n.utime),style:n.verify?"color:green;":"color:rgb(195, 45, 9);background-color:#FBFEC0;"})}}w2ui["grid_admin_soldier"].records=o;w2ui["grid_admin_soldier"].sort("_id","desc");w2ui["grid_admin_soldier"].refresh();setTimeout(function(){i.set("admin_soldier",{count:o.length});t.unlock("main")},100)},del:function(i){var o=this;w2confirm("确定删除所选兵蚁?",function(r){if(r!=="Yes"){return false}t.lock("main","删除兵蚁中..",true);e.post("/addons/ant.admin.soldier/del",{ids:i},function(e){t.unlock("main");if(!e.err){toastr.success("删除成功!","Success");i.forEach(function(e){delete o.cache[e]});o.reload()}else{toastr.error("删除失败!<br>"+e.err,"Error")}})})},verify:function(i,o){var r=this;if(o){w2confirm("确定审核所选兵蚁吗?",function(o){if(o!=="Yes"){return false}t.lock("main","审核兵蚁中..",true);e.post("/addons/ant.admin.soldier/verify",{ids:i,verify:true},function(e){t.unlock("main");if(!e.err){toastr.success("审核成功!","Success");i.forEach(function(e){r.cache[e].verify=true});r.reload()}else{toastr.error("审核失败!<br>"+e.err,"Error")}})})}else{w2confirm("确定取消审核所选兵蚁吗?",function(o){if(o!=="Yes"){return false}t.lock("main","取消审核兵蚁中..",true);e.post("/addons/ant.admin.soldier/verify",{ids:i,verify:false},function(e){t.unlock("main");if(!e.err){toastr.success("取消审核成功!","Success");i.forEach(function(e){r.cache[e].verify=false});r.reload()}else{toastr.error("取消审核失败!<br>"+e.err,"Error")}})})}},setting:function(i){var t=this,o=t.cache[i];w2popup.open({title:'<i class="fa fa-pencil"></i> 更改设置',body:'<div id="form_admin_soldier_div" style="width: 100%;height:100%"></div>',style:"padding: 0",modal:true,width:550,height:350,onOpen:function(r){r.onComplete=function(){w2ui["form_admin_soldier"]?w2ui["form_admin_soldier"].destroy():null;e("#form_admin_soldier_div").w2form(t.ui.form_admin_soldier);w2ui["form_admin_soldier"].record={name:o.name,coin:o.coin,desc:o.desc};w2ui["form_admin_soldier_toolbar"].onClick=function(r){if(r.target==="save"){w2popup.lock("保存兵蚁信息中..",true);var n=w2ui["form_admin_soldier"].record;e.post("/addons/ant.admin.soldier/setting",e.extend({},n,{id:i}),function(r){w2popup.unlock();if(r.err){toastr.error("保存失败!<br>"+r.err,"Error")}else{toastr.success("保存成功!","Success");t.cache[i]=e.extend({},o,n);t.reload();w2popup.close()}})}}}}})},edit:function(i){var t=this,o=t.cache[i];w2popup.open({title:'<i class="fa fa-edit"></i> 编辑兵蚁:<strong class="text-danger">'+w2utils.encodeTags(o.name)+"</strong>",body:'<div id="layout_admin_soldier_div" style="width: 100%;height: 100%;"></div>',style:"padding: 0;",showMax:true,modal:true,width:900,height:600,onOpen:function(i){i.onComplete=function(){e("#layout_admin_soldier_div").w2render(w2ui["layout_admin_soldier"]);var i=require("ace/mode/javascript").Mode;t.editor.client=ace.edit("layout_admin_soldier_client");t.editor.client.setTheme("ace/theme/tomorrow");t.editor.client.session.setMode(new i);t.editor.client.session.setUseWrapMode(true);t.editor.client.session.setValue(o.code.client);t.editor.server=ace.edit("layout_admin_soldier_server");t.editor.server.setTheme("ace/theme/tomorrow");t.editor.server.session.setUseWrapMode(true);t.editor.server.session.setValue(o.code.server);[{name:"saveCmd",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){w2ui["layout_admin_soldier_main_toolbar"].click("save")}},{name:"toggleCmd",bindKey:{win:"Ctrl-M",mac:"Command-M"},exec:function(){w2popup.toggle()}}].forEach(function(e){t.editor.client.commands.addCommand(e);t.editor.server.commands.addCommand(e)});w2ui["layout_admin_soldier_main_toolbar"].onClick=function(i){if(i.target==="save"){var r=t.editor.client.getValue();var n=t.editor.server.getValue();w2popup.lock("保存代码中..",true);e.post("/addons/ant.admin.soldier/save",{id:o._id,client:r,server:n},function(e){w2popup.unlock();if(e.err){toastr.error("代码保存失败!<br>"+e.err,"Error")}else{o.code={client:r,server:n};toastr.success("代码保存成功!","Success")}})}};w2ui["layout_admin_soldier_main_tabs"].click("client");w2popup.toggle()}},onToggle:function(e){e.onComplete=function(){w2ui["layout_admin_soldier"].resize();t.editor.client.resize();t.editor.server.resize()}}})}};e().w2grid(o.ui.grid_admin_soldier);e().w2layout(o.ui.layout_admin_soldier);i.add("ant_admin",{id:"admin_soldier",icon:"fa fa-coffee",text:"兵蚁审核",onClick:function(){o.refresh()},onDblClick:function(){delete o.cache;o.refresh()}})})(jQuery,w2ui["sidebar"],w2ui["layout"])})();