(function(e){(function(e,t){var i={ui:{grid_blog_private:{name:"grid_blog_private",show:{lineNumbers:true,selectColumn:true,footer:true,toolbar:true,expandColumn:true},multiSearch:false,columns:[{field:"_id",hidden:true,caption:"ID"},{field:"_ctime",hidden:true,caption:"CTIME"},{field:"category",caption:"蚁记目录",size:"15%",sortable:true},{field:"title",caption:"蚁记标题",size:"35%",sortable:true},{field:"public",caption:"是否分享",size:"10%",sortable:true},{field:"verify",caption:"是否审核",size:"10%",sortable:true},{field:"ctime",caption:"创建时间",size:"15%",sortable:true},{field:"utime",caption:"更新时间",size:"15%",sortable:true}],records:[],searches:[{field:"category",caption:"蚁记目录",type:"text"},{field:"title",caption:"蚁记标题",type:"text"},{field:"public",caption:"是否分享",type:"text"},{field:"verify",caption:"是否审核",type:"text"},{field:"ctime",caption:"创建时间",type:"text"},{field:"utime",caption:"更新时间",type:"text"}],toolbar:{items:[{type:"break"},{id:"add",type:"button",caption:"添加蚁记",icon:"fa fa-plus-circle"},{type:"break"},{id:"view",type:"button",disabled:true,caption:"浏览蚁记",icon:"fa fa-eye"},{type:"break"},{id:"desc",type:"button",disabled:true,caption:"蚁记简介",icon:"fa fa-info-circle"},{type:"break"},{id:"edit",type:"button",disabled:true,caption:"编辑蚁记",icon:"fa fa-edit"},{type:"break"},{id:"set",type:"button",disabled:true,caption:"更改设置",icon:"fa fa-cog"},{type:"break"},{id:"del",type:"button",disabled:true,caption:"删除蚁记",icon:"fa fa-trash-o"}],onClick:function(e){var t=[],o=w2ui["grid_blog_private"];o.getSelection().forEach(function(e){t.push(o.get(e)._id)});var a=o.get(o.getSelection()[0]);switch(e.target){case"add":i.private.add();break;case"del":i.private.del(t);break;case"desc":i.private.desc(a.recid);break;case"view":i.private.view(t[0]);break;case"edit":i.private.edit(t[0]);break;case"set":i.private.set(t[0]);break}}},onSelect:function(e){var t=this;e.onComplete=function(){var e=[];t.getSelection().forEach(function(i){e.push(t.get(i)._id)});t.toolbar.disable("edit","desc","view","del","set");e.length===1?t.toolbar.enable("edit","desc","view","del","set"):e.length>1?t.toolbar.enable("del"):null}},onUnselect:function(e){this.onSelect(e)},onContextMenu:function(t){var o=[],a=this;a.getSelection().forEach(function(e){o.push(a.get(e)._id)});var n=a.get(a.getSelection()[0]);e().bmenu([{text:"浏览蚁记",icon:"fa fa-eye",disabled:o.length!==1,action:function(){i.private.view(o[0])}},{divider:true},{text:"蚁记简介",icon:"fa fa-info-circle",disabled:o.length!==1,action:function(){i.private.desc(n.recid)}},{divider:true},{text:"编辑蚁记",icon:"fa fa-edit",disabled:o.length!==1,action:function(){i.private.edit(o[0])}},{text:"更改设置",icon:"fa fa-cog",disabled:o.length!==1,action:function(){i.private.set(o[0])}},{divider:true},{text:"分享蚁记",icon:"fa fa-share-alt",disabled:o.length!==1||n.public==="是",action:function(){i.private.share(o[0],true)}},{text:"取消分享",icon:"fa fa-remove",disabled:o.length!==1||n.public==="否",action:function(){i.private.share(o[0],false)}},{divider:true},{text:"删除蚁记",icon:"fa fa-trash-o",count:o.length,disabled:o.length===0,action:function(){i.private.del(o)}}],t.originalEvent)},onExpand:function(t){var o=i.private.cache[this.get(t.recid)._id];e("#"+t.box_id).html('<div style="padding: 10px;height: auto;">'+w2utils.encodeTags(o.desc||"<暂无简介>").replace(/\n/g,"<br>")+"</div>").animate({height:100},100)},onDblClick:function(e){var t=this;e.onComplete=function(){t.toggle(t.getSelection())}}},grid_blog_public:{name:"grid_blog_public",show:{lineNumbers:true,footer:true,toolbar:true,expandColumn:true},multiSearch:false,multiSelect:false,columns:[{field:"_id",hidden:true,caption:"ID"},{field:"_utime",hidden:true,caption:"UTIME"},{field:"category",caption:"蚁记目录",size:"15%",sortable:true},{field:"title",caption:"蚁记标题",size:"40%",sortable:true},{field:"user",caption:"蚁记作者",size:"15%",sortable:true},{field:"view",caption:"浏览次数",size:"10%",sortable:true},{field:"utime",caption:"更新时间",size:"20%",sortable:true}],records:[],searches:[{field:"category",caption:"蚁记目录",type:"text"},{field:"title",caption:"蚁记标题",type:"text"},{field:"public",caption:"蚁记作者",type:"text"},{field:"verify",caption:"浏览次数",type:"text"},{field:"utime",caption:"更新时间",type:"text"}],toolbar:{items:[{type:"break"},{id:"view",type:"button",disabled:true,caption:"浏览蚁记",icon:"fa fa-eye"},{type:"break"},{id:"desc",type:"button",disabled:true,caption:"蚁记简介",icon:"fa fa-info-circle"},{type:"break"},{id:"love",type:"button",disabled:true,caption:"收藏蚁记",icon:"fa fa-cloud-download"}],onClick:function(e){var t=w2ui["grid_blog_public"];var o=t.get(t.getSelection()[0]);switch(e.target){case"desc":i.public.desc(o.recid);break;case"view":i.public.view(o._id);break;case"love":i.public.love(o._id);break}}},onSelect:function(e){e.onComplete=function(){var e=this.getSelection();e.length===0?this.toolbar.disable("view","desc","love"):this.toolbar.enable("view","desc","love")}},onUnselect:function(e){this.onSelect(e)},onContextMenu:function(t){var i=this;e().bmenu([{text:"浏览蚁记",icon:"fa fa-eye",action:function(){i.toolbar.click("view")}},{divider:true},{text:"蚁记简介",icon:"fa fa-info-circle",action:function(){i.toolbar.click("desc")}},{divider:true},{text:"收藏蚁记",icon:"fa fa-cloud-download",action:function(){i.toolbar.click("love")}}],t.originalEvent)},onExpand:function(t){var o=i.public.cache[this.get(t.recid)._id];e("#"+t.box_id).html('<div style="padding: 10px;height: auto;">'+w2utils.encodeTags(o.desc||"<暂无简介>").replace(/\n/g,"<br>")+"</div>").animate({height:100},100)},onDblClick:function(e){var t=this;e.onComplete=function(){t.toggle(t.getSelection())}}},layout_blog_edit:{name:"layout_blog_edit",panels:[{size:"100%",type:"left",style:"border: 1px solid #dfdfdf;",content:'<div id="layout_blog_edit_editor"></div>',resizable:true,toolbar:{items:[{id:"save",icon:"fa fa-save",hint:"[Ctrl || Command] + S",type:"button",caption:"保存"},{type:"break"},{id:"link",icon:"fa fa-link",type:"button",caption:"链接"},{type:"break"},{id:"img",icon:"fa fa-file-image-o",type:"button",caption:"图片"},{type:"break"},{id:"music",icon:"fa fa-file-audio-o",type:"button",caption:"音乐"},{type:"break"},{id:"movie",icon:"fa fa-file-movie-o",type:"button",caption:"视频"},{type:"break"},{id:"file",icon:"fa fa-file-zip-o",type:"button",caption:"文件"},{type:"break"},{type:"spacer"},{id:"preview",type:"check",icon:"fa fa-eye",hint:"[Ctrl || Command] + E",caption:"预览"}]}},{size:"100%",type:"main",style:"border: 1px solid #dfdfdf;",content:'<div id="blog_view_content"></div>',resizable:true}]},form_blog:{name:"form_blog",style:"height: 100%;border: 0px;background-color: transparent;",fields:[{field:"category",type:"combo",required:true,html:{caption:"蚁记目录",attr:'style="width: 250px"'},options:{items:[]}},{field:"title",type:"text",required:true,html:{caption:"蚁记标题",attr:'style="width: 250px"'}},{field:"desc",type:"textarea",html:{caption:"蚁记简介",attr:'rows="8" style="width: 250px;"'}}]}},init:function(){e().w2grid(this.ui.grid_blog_private);e().w2grid(this.ui.grid_blog_public);e().w2layout(this.ui.layout_blog_edit)},blog:{parse:function(t,i,o){e("#"+t).html(marked(o||i.content));e("#"+t+" pre code").each(function(t,i){hljs.highlightBlock(i);var o=e(this).text().split("\n").length-1;var a=e("<ul/>").addClass("pre-numbering");e(this).addClass("has-numbering").parent().append(a);for(t=1;t<=o;t++){a.append(e("<li/>").text(t))}});e("#"+t+" audio").audioPlayer({classPrefix:"audioplayer",strPlay:"播放",strPause:"暂停",strVolume:"音量"});var a=e("#"+t+" #movie-player-");for(var n=0;n<a.length;n++){var l=e(a[n]).attr("id");e(a[n]).attr("id",l+n);var c={source:e(a[n]).attr("src"),parentId:"#"+t+" #"+e(a[n]).attr("id"),autoPlay:e(a[n]).attr("play")==="true"?true:false};new Clappr.Player(c)}if(!o){e("#"+t).append('<hr><div id="blog_comment_'+i._id+'"></div>');e("#blog_comment_"+i._id).comment({key:i._id,url:"#!/blog/"+(i.verify?"public":"private")+"/"+i._id,title:(i.verify?"蚁记分享 - ":"私人蚁记 - ")+i.title})}}},"private":{cache:null,category:[],refresh:function(){var t=this;i.content(w2ui["grid_blog_private"]);if(!t.cache){t.cache={};i.lock("加载蚁记数据中..");e.get("/addons/ant.blog/private/data",function(e){var i={};t.category=[];e.forEach(function(e){t.cache[e._id]=e;i[e.category]=0});for(var o in i){t.category.push(o)}t.reload()})}},reload:function(){var e=this;var t=[];for(var o in e.cache){var a=e.cache[o];if(a){t.push({recid:t.length+1,_id:a._id,category:w2utils.encodeTags(a.category),title:w2utils.encodeTags(a.title),"public":a.public?"是":"否",verify:a.public?a.verify?"是":"否":"-",ctime:ANT.ftime(a.ctime),_ctime:a.ctime,utime:ANT.ftime(a.utime),style:"color: "+(a.public?a.verify?"rgb(22, 144, 61)":"rgb(195, 45, 9)":"")})}}w2ui["grid_blog_private"].records=t;w2ui["grid_blog_private"].sort("_ctime","desc");w2ui["grid_blog_private"].refresh();setTimeout(function(){w2ui.sidebar.set("blog_private",{count:t.length});i.unlock()},100)},add:function(){var t=this;w2popup.open({title:'<i class="fa fa-plus-circle"></i> 添加蚁记',body:'<div id="ant_blog_add_div"></div>',style:"padding: 15px 0 0 0",modal:true,width:500,height:320,onOpen:function(o){o.onComplete=function(){i.ui["form_blog"].fields[0].options.items=t.category;var o=e.extend({},i.ui["form_blog"],{actions:{"添加":function(){if(this.validate().length===0){w2popup.lock("添加蚁记中..",true);e.post("/addons/ant.blog/private/add",this.record,function(e){w2popup.unlock();if(e.ret){w2popup.close();i.success("添加兵蚁成功!");t.cache[e.ret._id]=e.ret;t.reload();i.private.edit(e.ret._id)}else{i.error("添加兵蚁失败!<br>"+e.err)}})}}}});e("#ant_blog_add_div").w2form(o)}},onClose:function(e){w2ui["form_blog"].destroy()}})},del:function(t){var o=this;w2confirm("确定删除所选的("+t.length+")条数据吗?",'<i class="fa fa-trash-o"></i> 删除蚁记',function(a){if(a==="Yes"){i.lock("删除数据中..");e.post("/addons/ant.blog/private/del",{ids:t},function(e){i.unlock();if(!e.err){i.success("删除数据成功!");t.forEach(function(e){delete o.cache[e]});o.reload()}else{i.error("删除数据失败!")}})}})},desc:function(e){w2ui["grid_blog_private"].toggle(e)},share:function(t,o){var a=this,n=this.cache[t];w2confirm("确定"+(o?"分享":"取消分享")+"所选蚁记?",'<i class="fa fa-'+(o?"share-alt":"remove")+'"></i> '+(o?"分享蚁记":"取消分享"),function(l){if(l==="Yes"){i.lock(o?"分享蚁记中..":"取消分享中..");e.post("/addons/ant.blog/private/share",{id:t,share:o?1:0},function(e){i.unlock();if(!e.err){i.success(o?"分享蚁记成功!":"取消分享成功!")}else{i.error((o?"分享蚁记":"取消分享")+"失败!<br>"+e.err)}n.public=e.err?false:o;a.reload()})}})},edit:function(t){var o=this,a=o.cache[t],n=null;w2popup.open({title:'<i class="fa fa-edit"></i> 编辑蚁记:<strong class="text-success">'+w2utils.encodeTags(a.title)+"</strong>",body:'<div id="layout_blog_edit_div" style="width: 100%;height: 100%;"></div>',style:"padding: 0;",showMax:true,modal:true,width:900,height:600,onOpen:function(l){l.onComplete=function(){e("#layout_blog_edit_div").w2render(w2ui["layout_blog_edit"]);var l=require("ace/mode/markdown").Mode;n=ace.edit("layout_blog_edit_editor");n.setTheme("ace/theme/tomorrow");n.session.setMode(new l);n.session.setUseWrapMode(true);n.session.setValue(a.content||"");[{name:"saveCmd",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){w2ui["layout_blog_edit_left_toolbar"].click("save")}},{name:"previewCmd",bindKey:{win:"Ctrl-E",mac:"Command-E"},exec:function(e){w2ui["layout_blog_edit_left_toolbar"].click("preview")}},{name:"toggleCmd",bindKey:{win:"Ctrl-M",mac:"Command-M"},exec:function(){w2popup.toggle()}},{name:"insertLink",bindKey:{win:"Ctrl-I",mac:"Command-I"},exec:function(){w2ui["layout_blog_edit_left_toolbar"].click("link")}}].forEach(function(e){n.commands.addCommand(e)});n.session.on("change",function(e){w2ui["layout_blog_edit_left_toolbar"].get("preview").checked?i.blog.parse("blog_view_content",a,n.getValue()):null});w2ui["layout_blog_edit_left_toolbar"].onClick=function(l){switch(l.target){case"save":w2popup.lock("保存蚁记中..",true);e.post("/addons/ant.blog/private/save",{id:t,content:n.getValue()},function(e){w2popup.unlock();if(e.err){i.error("保存蚁记失败!<br>"+e.err)}else{i.success("保存蚁记成功!");a.utime=new Date;a.content=n.getValue();a.verify=false;o.reload()}});break;case"preview":w2ui["layout_blog_edit"].set("left",{size:!l.object.checked?"50%":"100%"});this.set("preview",{icon:!l.object.checked?"fa fa-eye fa-spin":"fa fa-eye"});!l.object.checked?i.blog.parse("blog_view_content",a,n.getValue()):null;break;case"link":var c=prompt("请输入链接地址");n.insert("["+(c||"链接标题")+"]("+(c||"链接地址")+")");break}};e("#tb_layout_blog_edit_left_toolbar_item_img").bindUpload(function(e,t){n.insert("!["+e+"]("+t+")\n")});e("#tb_layout_blog_edit_left_toolbar_item_file").bindUpload(function(e,t){n.insert("~["+e+"]("+t+")\n")});e("#tb_layout_blog_edit_left_toolbar_item_music").bindUpload(function(e,t){n.insert("m["+e+"]("+t+")\n")});e("#tb_layout_blog_edit_left_toolbar_item_movie").bindUpload(function(e,t){n.insert("M["+e+"]("+t+")\n")});w2popup.toggle()}},onToggle:function(e){e.onComplete=function(){w2ui["layout_blog_edit"].set("left",{size:w2ui["layout_blog_edit_left_toolbar"].get("preview").checked?"50%":"100%"});w2ui["layout_blog_edit"].resize();n.resize()}},onClose:function(e){this.onMin(e)},onMin:function(e){e.onComplete=function(){w2ui["layout_blog_edit_left_toolbar"].get("preview").checked?w2ui["layout_blog_edit_left_toolbar"].click("preview"):null}}})},view:function(e){var t=this;var o=t.cache[e];w2popup.open({title:'<span class="text-info"><i class="fa fa-book"></i> '+w2utils.encodeTags(o.title)+"</span>",style:"padding: 0;background-color: #f5f6f7;",modal:true,showMax:true,width:1e3,height:650,body:'<div id="blog_view_content" style="width: 100%;height: 100%"></div>',onOpen:function(e){e.onComplete=function(){i.blog.parse("blog_view_content",o)}}})},set:function(t){var o=this,a=o.cache[t];w2popup.open({title:'<i class="fa fa-pencil"></i> 更改设置',body:'<div id="ant_blog_set_div"></div>',style:"padding: 15px 0 0 0",modal:true,width:500,height:350,onOpen:function(n){n.onComplete=function(){i.ui["form_blog"].fields[0].options.items=o.category;var n=e.extend({},i.ui["form_blog"],{record:{category:{id:a.category,text:a.category},title:a.title,desc:a.desc},actions:{"保存":function(){if(this.validate().length===0){w2popup.lock("保存设置中..",true);var n=this.record;n.category=typeof n.category==="object"?n.category.text:n.category;e.post("/addons/ant.blog/private/set",e.extend(n,{id:t}),function(e){w2popup.unlock();if(!e.err){w2popup.close();i.success("保存设置成功!");a.category=n.category;a.title=n.title;a.desc=n.desc;a.verify=false;a.utime=new Date;o.reload()}else{i.error("保存设置失败!<br>"+e.err)}})}}}});e("#ant_blog_set_div").w2form(n)}},onClose:function(e){w2ui["form_blog"].destroy()}})}},"public":{cache:null,refresh:function(){var t=this;i.content(w2ui["grid_blog_public"]);if(!t.cache){t.cache={};i.lock("加载蚁记数据中..");e.get("/addons/ant.blog/public/data",function(e){e.forEach(function(e){t.cache[e._id]=e});t.reload()})}},reload:function(){var e=this;var t=[];for(var o in e.cache){var a=e.cache[o];if(a){t.push({recid:t.length+1,_id:a._id,category:w2utils.encodeTags(a.category),title:w2utils.encodeTags(a.title),user:w2utils.encodeTags(a.user?a.user.nickname||"<已删除>":"<已删除>"),utime:ANT.ftime(a.utime),_utime:a.utime,view:a.view||0})}}w2ui["grid_blog_public"].records=t;w2ui["grid_blog_public"].sort("_utime","desc");w2ui["grid_blog_public"].refresh();setTimeout(function(){w2ui.sidebar.set("blog_public",{count:t.length});i.unlock()},100)},view:function(t){var o=this;var a=o.cache[t];w2popup.open({title:'<span class="text-info"><i class="fa fa-book"></i> '+w2utils.encodeTags(a.title)+"</span>",style:"padding: 0;background-color: #f5f6f7;",modal:true,showMax:true,width:1e3,height:650,body:'<div id="blog_view_content" style="width: 100%;height: 100%"></div>',onOpen:function(o){o.onComplete=function(){if(!a.content){w2popup.lock("加载蚁记中..",true);e.post("/addons/ant.blog/public/view",{id:t},function(e){w2popup.unlock();if(e.ret){a.content=e.ret.content;i.blog.parse("blog_view_content",a)}else{w2popup.close();i.error("加载蚁记失败!")}})}else{i.blog.parse("blog_view_content",a)}}}})},desc:function(e){w2ui["grid_blog_public"].toggle(e)},love:function(t){w2confirm("确定收藏此蚁记到私人目录吗？",'<i class="fa fa-cloud-download"></i> 收藏蚁记',function(o){if(o==="Yes"){i.lock("收藏蚁记中..");e.post("/addons/ant.blog/public/love",{id:t},function(e){i.unlock();if(e.ret){i.success("收藏蚁记成功!");if(i.private.cache){i.private.cache[e.ret._id]=e.ret;i.private.reload();w2ui["sidebar"].click("blog_private")}else{w2ui["sidebar"].dblClick("blog_private");w2ui["sidebar"].select("blog_private")}}else{i.error("收藏蚁记失败!<br>"+e.err)}})}})}}};ANT.initAddon({id:"ant_blog",libs:{js:["/addons/ant.blog/libs/highlight.js","/addons/ant.blog/libs/marked.js","/addons/ant.blog/libs/upload.js","/addons/ant.blog/libs/audioplayer.js","/addons/ant.blog/libs/clappr.min.js"],css:["/addons/ant.blog/libs/highlight.css","/addons/ant.blog/client.css"]},text:"蚁记一技",group:true,expanded:true,nodes:[{id:"blog_public",text:"蚁记分享",icon:"fa fa-book",onClick:function(){i.public.refresh()},onDblClick:function(){delete i.public.cache;i.public.refresh()}},{id:"blog_private",text:"私人蚁记",icon:"fa fa-book",onClick:function(){i.private.refresh()},onDblClick:function(){delete i.private.cache;i.private.refresh()}}]},i)})(jQuery)})();